# 소트 연산

## 소트 수행 과정
소트는 기본적으로 PGA에 할당한 Sort Area에서 이루어진다. 메모리 공간이 Sort Area가 다 차면 디스크 Temp 테이블 스페이스를 활용한다.
- **메모리 소트**(In-Memory Sort): 전체 데이터의 정렬 작업을 메모리 내에서 완료하는 것을 말하며, 'Internal Sort'라고 한다.
- **디스크 소트**(To-Disk Sort): 할당받은 Sort Area 내에서 정렬을 완료하지 못해 디스크 공간까지 사용하는 것을 말하며, 'External Sort'라고도 한다. 

소트 연산은 메모리 집약적일 뿐만 아니라 CPU 집약적이기도 하다.
처리할 데이터양이 많을 때는 디스크 I/O까지 발생하므로 쿼리 성능을 좌우하는 매우 중요한 요소다.

또한 **부분 범위 처리를 불가능**하게 함으로써 OLTP 환경에서 애플리케이션 성능을 저하시키는 주요인이 되기도 한다.

될 수 있으면 소트가 발생하지 않도록 SQL을 작성해야 하고, 소트가 불가피하다면 메모리 내에서 수행을 완료할 수 있도록 해야 한다.

## 소트 오퍼레이션
소트를 발생시키는 오퍼레이션에 대해 알아보자.

### Sort Aggregate
소팅 알고리즘을 사용해 집계를 수행할 때 나타난다.

실제로 데이터를 정렬하지는 않으며, Sort Area를 사용한다는 의미로 이해하면 된다.
```sql
select sum(sal), max(sal), min(sal), avg(sal) from emp;
```

SUM, MAX, MIN, AVG 값을 구하는 절차는 다음과 같다.

1. Sort Area에 SUM, MAX, MIN, COUNT값을 위한 변수를 하나씩 할당한다.
2. EMP 테이블에서 레코드를 하나씩 읽어 내려가면서 값을 갱신한다.
3. SUM, MAX, MIN 변수에 닮긴 값을 그대로 출력하고, AVG는 SUM을 COUNT로 나눈 값을 출력한다.

### Sort Order By
데이터를 정렬할 때 나타난다.
```sql
select * from emp order by sal desc;
```

### Sort Group By
소팅 알고리즘을 사용해 그룹별 집계를 수행할 때 나타난다.
```sql
select deptno, sum(sal), max(sal), min(sal), avg(sal)
from emp
group by deptno
order by deptno;
```

Sort Aggregate에서 사용했던 방식을 똑같이 사용한다.

부서 번호별로 SUM, MAX, MIN, COUNT값을 위한 변수를 할당하며, 값을 읽다가 새로운 부서 정보가 나타날 때마다 정렬 순서에 맞게 변수를 할당한다.
EMP 테이블에서 레코드를 읽어 내려가면서 값을 갱신한다.

오라클 10gR2에서 Hash Group By가 도입되면서 Group By 절 뒤에 Order By 절을 명시하지 않으면 대부분 Hash Group By로 처리된다.
Sort Group By에서는 부서 번호 별 변수를 찾기 위해 소팅 알고리즘을 사용했다면, Hash Group By는 해싱 알고리즘을 사용한다.

### Sort Unique
중복 제거를 위한 소트 연산 시에 나타난다.

Unnesting 된 서브쿼리가 M쪽 집합이면(1쪽 집합이라도 조인 컬럼에 Unique 인덱스가 없으면), 메인쿼리와 조인하기 전에 중복 레코드부터 제거해야 한다.
이때 Sort Unique 오퍼레이션이 나타난다.

만약 PK/Unique 제약 또는 Unique 인덱스를 통해 Unnesting 된 서브쿼리의 유일성이 보장된다면, Sort Unique 오퍼레이션은 생략된다.

```sql
select /*+ ordered use_nl(dept) */ * from dept
where deptno in (select /*+ unnest */ deptno
                 from emp where job = 'CLERK');
```

Union, Minus, Intersect 같은 집합(Set) 연산자를 사용할 때도 Sort Unique 오퍼레이션이 나타난다.

```sql
select job, mgr from emp where deptno = 10
union
select job, mgr from emp where deptno = 20;
```

Distinct 연산자를 사용할 때도 Sort Unique 오퍼레이션이 나타난다.
```sql
select distinct deptno from emp order by deptno;
```
오라클 10gR2부터는 Distinct 연산에도 Hash Unique 방식을 사용한다. Order By 절을 명시하지 않으면 Hash Unique로 처리된다.

### Sort Join
소트 머지 조인을 수행할 때 나타난다.
```sql
select /*+ ordered use_merge(e) */ *
from dept d, emp emp
where d.deptno = e.deptno;
```

### Window Sort
윈도우 함수(분석 함수)를 수행할 때 나타난다.
```sql
select empno, ename, job, mgr, sal
     , avg(sal) over (partition by deptno)
from emp;
```

---
**Reference**
- 친절한 SQL 튜닝 5장
