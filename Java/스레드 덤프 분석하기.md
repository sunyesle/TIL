# 스레드 덤프 분석하기

## 스레드 덤프 생성
### PID 확인
스레드 덤프를 획득하려면 먼저 수행 중인 Java 애플리케이션 프로세스의 PID를 확인해야 한다. PID는 **jps**로 확인할 수 있다.
```
jps -v
```

### 1. jstack
**jstack**은 스레드 덤프를 출력하는 JDK 유틸리티로, JDK 1.5 버전부터 제공된다.
```
jstack [options] <pid>

예시) jstack 12512 >> thread_dump.txt
```
**옵션 목록**
- `-F`: 스레드 덤프를 강제로 실행합니다. jstack pid가 응답하지 않을 때(프로세스가 중단된 경우) 사용하면 편리하다.
- `-l`: `java.util.concurrent` Lock 정보를 함께 출력한다.
- `-m`: Java 스택 프레임 외에도 네이티브 스택 프레임(C 및 C++)을 인쇄한다.

### 2. jcmd
**jcmd**는 JVM 진단용 도구로 스레드 덤프, 힙 덤프 등 다양한 기능을 제공한다.
`jcmd <pid> help`로 사용할 수 있는 명령을 확인할 수 있다.

JDK 1.8 버전부터 제공되며, 성능 오버헤드 감소를 위해서 jstack 유틸리티 대신 jcmd 사용이 권장된다.
```
jcmd <pid> Thread.print [options] >> thread_dump.txt

예시) jcmd 12512 Thread.print >> thread_dump.txt
```
**옵션 목록** (`jcmd <pid> help Thread.print`로 확인 가능)
- `-l`: `java.util.concurrent` Lock 정보를 함께 출력한다.
- `-e`: 스레드에 대해 더 자세한 정보를 출력한다.

## 스레드 덤프 정보
스레드 덤프에는 다음과 같은 정보가 들어 있다.

```bash
"Thread-0" #20 [1792] prio=5 os_prio=0 cpu=8000.00ms elapsed=7.99s tid=0x0000018f54404970 nid=1792 runnable  [0x00000051734fe000]
   java.lang.Thread.State: RUNNABLE
        at com.sunys.Main.lambda$main$0(Main.java:8)
        at com.sunys.Main$$Lambda/0x0000018f56000a00.run(Unknown Source)
        at java.lang.Thread.runWith(java.base@21.0.2/Thread.java:1596)
        at java.lang.Thread.run(java.base@21.0.2/Thread.java:1583)
```

| 항목 | 예시 | 설명 |
|------|------|------|
| **Thread Name** | `"Thread-0"` | 스레드 이름 |
| **ID** | `#20` | JVM 내 각 스레드에 할당된 고유 ID |
| **Thread Priority** | `prio=5` | Java 스레드의 우선순위 |
| **OS Thread Priority** | `os_prio=0` | 매핑된 OS 스레드의 우선순위 (Java 스레드는 OS 스레드와 매핑된다) |
| **CPU Time** | `cpu=8000.00ms` | 스레드의 CPU 사용 시간 |
| **Elapsed Time** | `elapsed=7.99s` | 스레드가 생성된 후 경과된 시간 |
| **Java-Level Thread ID** | `tid=0x0000018f54404970` | JVM 내부에서 관리하는 Native Thread 구조체의 포인터 주소 |
| **Native Thread ID** | `nid=1792` | 자바 스레드에 매핑된 OS 스레드의 ID |
| **Thread State** | `runnable` | 스레드 상태 |
| **Last Known Java Stack Pointer** | `[0x00000051734fe000]` | 스레드의 현재 Stack Pointer 주소 |
| **Call Stack** |  | 스레드의 콜 스택 |

## 예제
데드락을 발생시키는 코드이다.
```java
public class Main {
    public static void main(String[] args) {
        Object resource1 = new Object();
        Object resource2 = new Object();

        Thread t1 = new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread().getName() + ": locked resource 1");
                try { Thread.sleep(100); } catch (Exception e) { }
                synchronized (resource2) {
                    System.out.println(Thread.currentThread().getName() + ": locked resource 2");
                }
            }
        });

        Thread t2 = new Thread(() -> {
            synchronized (resource2) {
                System.out.println(Thread.currentThread().getName() + ": locked resource 2");
                try { Thread.sleep(100); } catch (Exception e) { }
                synchronized (resource1) {
                    System.out.println(Thread.currentThread().getName() + ": locked resource 1");
                }
            }
        });

        t1.start();
        t2.start();
    }
}
```
> **출력:**<br>
> Thread-0: locked resource 1<br>
> Thread-1: locked resource 2

<br>

코드를 실행시키고 스레드 덤프를 생성한다.
```bash
C:\Users\Home10>jps
12904 Main

C:\Users\Home10>jcmd 12904 Thread.print >> thread_dump.txt
```

<br>

생성된 덤프 파일에서 데드락이 발생한 스레드 정보를 확인할 수 있다.
```text
...생략...

Found one Java-level deadlock:
=============================
"Thread-0":
  waiting to lock monitor 0x00000146314436e0 (object 0x0000000620dc1108, a java.lang.Object),
  which is held by "Thread-1"

"Thread-1":
  waiting to lock monitor 0x0000014631443940 (object 0x0000000620dc10f8, a java.lang.Object),
  which is held by "Thread-0"

Java stack information for the threads listed above:
===================================================
"Thread-0":
	at com.sunys.Main.lambda$main$0(Main.java:18)
	- waiting to lock <0x0000000620dc1108> (a java.lang.Object)
	- locked <0x0000000620dc10f8> (a java.lang.Object)
	at com.sunys.Main$$Lambda/0x0000014659000a00.run(Unknown Source)
	at java.lang.Thread.runWith(java.base@21.0.2/Thread.java:1596)
	at java.lang.Thread.run(java.base@21.0.2/Thread.java:1583)
"Thread-1":
	at com.sunys.Main.lambda$main$1(Main.java:33)
	- waiting to lock <0x0000000620dc10f8> (a java.lang.Object)
	- locked <0x0000000620dc1108> (a java.lang.Object)
	at com.sunys.Main$$Lambda/0x0000014659000c20.run(Unknown Source)
	at java.lang.Thread.runWith(java.base@21.0.2/Thread.java:1596)
	at java.lang.Thread.run(java.base@21.0.2/Thread.java:1583)

Found 1 deadlock.
```

---
**Reference**
- https://docs.oracle.com/en/java/javase/21/troubleshoot/diagnostic-tools.html
- https://d2.naver.com/helloworld/10963
- https://steady-coding.tistory.com/597
- https://www.baeldung.com/java-thread-dump
