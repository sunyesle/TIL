# 세션
## 세션(Session)
세션은 특정 시간동안 동일한 사용자로부터 들어오는 일련의 요청을 의미한다.
세션 관리는 사용자를 식별하고 상태 정보를 유지하는 방법을 말한다.

HTTP는 무상태(stateless) 프로토콜이기 때문에, 상태 정보를 유지하기 위해 별도의 메커니즘이 필요하다.

## 서블릿과 세션
서블릿 컨테이너(Tomcat, Jetty 등)는 세션 관리를 담당한다.
컨테이너는 서블릿 스펙을 구현하여 세션 생성, 식별, 저장, 조회, 만료 기능을 제공한다.

### 동작 방식
최초 요청 시 서블릿 컨테이너는 클라이언트에게 고유한 세션 ID를 발급한다.
서버는 세션 ID 별로 세션 정보를 저장하며, 세션 ID는 쿠키 또는 URL Rewrite를 통해 클라이언트에게 전달된다.

이후 클라이언트가 요청을 보낼 때 세션 ID를 함께 전달하면, 서버는 세션 ID를 통해 세션 정보를 조회할 수 있다.

일정 시간 요청이 없거나, 서버에서 `session.invalidate()`를 호출하는 경우 세션이 제거된다.

### HttpSession
서블릿에서 세션은 `HttpSession` 인터페이스 객체로 표현된다.
`HttpServletRequest.getSession()` 메서드를 통해 세션 객체를 얻을 수 있다.

주요 메서드 
- `setAttribute(String name, Object value)` : 세션에 데이터 저장
- `getAttribute(String name)` : 세션에서 데이터 조회
- `removeAttribute(String name)` : 세션에 저장된 데이터 삭제
- `invalidate()` : 세션 무효화(세션 제거)

#### 예시
```java
@WebServlet("/session")
public class SessionServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // 현재 요청에 연결된 세션을 반환한다.
        HttpSession session = req.getSession();

        // 세션에 데이터 저장
        session.setAttribute("user", "abc");

        // 세션에서 데이터 조회
        String user = (String) session.getAttribute("user");

        // 세션에서 데이터 삭제
        session.removeAttribute("user");

        // 세션 제거
        session.invalidate();

        resp.getWriter().write("Session user: " + user); // Session user: abc 
    }
}
```

#### Spring에서의 사용 예시
기본적으로 세션은 서블릿 컨테이너에서 생성, 관리된다. Spring은 서블릿 컨테이너가 만든 `HttpSession`을 주입하는 역할만 한다.
```java
@RestController
@RequestMapping("/session")
public class SessionController {

    @GetMapping
    public String handleSession(HttpSession session) { // 파라미터로 HttpSession을 주입 받는다.
        // 세션에 데이터 저장
        session.setAttribute("user", "abc");

        // 세션에서 데이터 조회
        String user = (String) session.getAttribute("user");

        // 세션에서 데이터 삭제
        session.removeAttribute("user");

        // 세션 제거
        session.invalidate();

        return "Session user: " + user; // Session user: abc
    }
}
```

## 세션의 특징
세션 데이터가 서버에 저장되므로, 쿠키나 로컬 스토리지에 비해 민감한 정보를 안전하게 관리할 수 있다.
또한 서버에서 직접 관리하기 때문에 만료, 무효화, 접근 제어 정책을 강제할 수 있다.

하지만 세션이 많아질수록 서버 메모리를 점유하여 부하가 발생한다.
따라서 세션 저장 데이터를 최소화하고, 세션 타임아웃을 적절히 설정하는 것이 좋다.

다중 서버 환경에서는 세션 불일치 문제가 발생할 수 있다.
이를 해결하기 위해 Sticky Session, Session Clustering, Session Storage 분리 등의 방법을 사용할 수 있다.

## 보안 이슈
세션 데이터는 서버에 저장되기 때문에 비교적 안전하지만 다음과 같은 보안 이슈를 갖고있다.
### 세션 하이재킹(Session Hijacking)
공격자가 사용자의 세션을 가로채는 행위이다.
- **HTTPS 사용**: 세션 ID를 암호화된 채널을 통해 전송하여 네트워크상에서 세션 ID가 노출되는 것을 막을 수 있다.
- **HttpOnly 쿠키 사용**: 이 옵션을 사용하면 클라이언트 측 스크립트에서 쿠키에 접근하는 것을 방지할 수 있다. XSS 공격을 통해 쿠키가 탈취되는 것을 막을 수 있다.
- **세션 타임아웃**: 사용자가 일정 시간 동안 활동하지 않으면 세션을 자동으로 만료시킨다. 공격자가 세션 ID를 탈취하더라도 이용할 수 있는 시간을 제한할 수 있다.
- **세션 재발급**: 로그인 후 또는 중요한 트랜잭션을 수행한 수 새로운 세션 ID를 발급한다. 공격자가 이전의 세션 ID를 알아내더라도 새로운 세션 ID를 알 수 없으므로 공격을 방지할 수 있다.
### 세션 고정 공격(Session Fixation)
공격자가 특정 세션 ID를 미리 지정하고, 이 세션 ID를 강제로 사용하게 함으로써 사용자의 세션을 공격자가 제어하게 만드는 공격이다.
- 이를 방지하기 위해 사용자가 로그인할 때마다 새로운 세션 ID를 발급하는 것이 중요하다.
### 세션 예측 공격(Session Prediction)
공격자가 세션 ID 생성 알고리즘을 예측하여 임의의 세션 ID를 생성하고, 그 세션 ID로 사용자의 세션을 도용하는 방법
- 이를 방지하기 위해 세션 ID는 랜덤하고 예측할 수 없는 방식으로 생성해야 한다.

---
**Reference**<br>
- https://en.wikipedia.org/wiki/Session_(computer_science)
- https://kadensungbincho.tistory.com/63
- https://www.ibm.com/docs/ko/was-nd/9.0.5?topic=applications-sessions
