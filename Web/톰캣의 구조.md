# 톰캣의 구조와 작동 원리

## Apache Tomcat
톰캣은 아파치 소프트웨어 재단에서 개발한 서블릿 컨테이너(웹 컨테이너)이다.
Java Servlet과 JSP를 실행할 수 있는 환경을 제공하며, 자체적으로 기본적인 HTTP 웹 서버 기능도 내장하고 있다.

## 톰캣 디렉토리
| 디렉토리 이름 | 설명                     |
|---------|---------------------------|
| bin     | 톰캣 실행/종료 및 관리를 위한 스크립트 파일이 위치  |
| conf    | 웹 어플리케이션에 필요한 설정 파일       |
| lib     | 톰캣에서 공통으로 사용하는 라이브러리           |
| logs    | 로그 파일                       |
| temp    | 임시 파일 저장 디렉토리                     |
| webapps | 웹 어플리케이션 배포 디렉토리              |
| work    | JSP가 Servlet 클래스로 변환되고 컴파일된 파일들이 저장되는 디렉토리 |

## 주요 설정 파일
| 파일 이름       | 설명                                                                                                                                                 |
|-------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| server.xml  | 톰캣 서버 설정<br>서버 포트, 커넥터, 엔진, 호스트 등을 정의                                                                                                              |
| context.xml | 애플리케이션 컨텍스트 설정<br>데이터소스, 환경변수, 세션 정책 등을 정의<br>`$CATALINA_HOME/conf/context.xml`은 전역 설정, 각 애플리케이션의 `META-INF/context.xml`은 개별 설정                    |
| web.xml     | 웹 애플리케이션 배포 서술자(Deployment Descriptor)<br>서블릿, 필터, 리스너, 초기화 파라미터 등을 정의<br>`$CATALINA_HOME/conf/web.xml`은 전역 설정, 각 애플리케이션의 `WEB-INF/web.xml`은 개별 설정 |


## 톰캣의 구조
<img width="530" height="356" alt="Image" src="https://github.com/user-attachments/assets/77045173-3529-4d0b-8da1-d5e42e3fe905" />

### Server
톰캣 전체 프로세스를 나타낸다.
톰캣 서버는 하나 이상의 Service를 구성하여 요청을 처리할 수 있다.

### Service
서비스는 여러 개의 커넥터와 하나의 엔진으로 구성된다.
커넥터가 받아들인 각각의 요청을 엔진으로 전달한다.

### Connector
클라이언트와의 통신을 담당한다. (HTTP, HTTPS, AJP 등)
- HTTP 커넥터: 주로 웹 브라우저와의 통신을 담당하며, HTTP/1.1 및 HTTP/2 프로토콜을 지원한다.
- AJP 커넥터: Apache HTTP 서버와의 연동을 위해 사용되며, Apache와 톰캣 간의 성능을 최적화하는 데 도움을 준다.

### Engine
요청을 처리하는 핵심 컴포넌트이다.
각 요청을 적절한 호스트로 전달한다.
엔진에는 하나 이상의 호스트가 포함되어야 하며, 그중 하나가 기본 호스트로 지정되어 있어야 한다.

### Host
엔진 내에서 특정 도메인(가상 호스트)을 관리하는 역할을 담당한다.
각 호스트는 하나 이상의 컨텍스트를 포함한다.
기본적으로 톰캣은 localhost Host를 제공하며, 여러 Host를 추가로 정의하여 가상 호스팅을 구성할 수 있다.

### Context
하나의 웹 애플리케이션을 나타낸다.

### Listener
리스너는 `org.apache.catalina.LifecycleListener` 인터페이스를 구현하여 특정 이벤트에 응답할 수 있는 자바 객체이다.

### Realm
톰캣 서버의 보안 영역을 담당하며, 사용자의 인증과 권한 부여를 관리한다.
데이터베이스, LDAP, 파일 시스템 등 다양한 소스에서 사용자 정보를 가져올 수 있으며, 요청에 따라 사용자의 자격 증명을 확인한 후 적절한 권한을 부여한다.

### Valve
톰캣 내부 파이프라인에서 요청/응답을 가로채서 로깅이나 필터링 등의 추가 작업을 수행하는데 사용된다.
Engine, Host, Context 수준에 추가할 수 있다.
- Engine Valve: 서버 전체 요청에 적용
- Host Valve: 특정 가상 호스트에만 적용
- Context Valve: 특정 웹 애플리케이션에만 적용

> 최근에는 Valve를 통해 필터링이나 로깅 등의 작업을 구현하는 경우는 드물다.<br>
> Servlet Filter, 스프링 인터셉터, AOP, API Gateway 등을 더 자주 사용한다.

## 톰캣의 구성 요소
톰캣을 구성하는 큰 단위로는 다음 3가지가 있다.
- **Coyote**(HTTP Component): 톰캣에 TCP를 통한 프로토콜을 지원한다. 웹서버 기능
- **Catalina**(Servlet Container): Java Servlet을 호스팅하는 환경
- **Jasper**(JSP Engine): JSP 페이지를 서블릿 클래스로 변환하고 컴파일한다. Catalina 내에 존재

---
**Reference**
- https://tomcat.apache.org/
- https://en.wikipedia.org/wiki/Apache_Tomcat
- https://sundaland.tistory.com/520
- https://kbss27.github.io/2017/11/16/tomcatarchitecture/
- https://kadensungbincho.tistory.com/58
