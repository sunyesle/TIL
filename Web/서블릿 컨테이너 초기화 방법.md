# Servlet Container 초기화 방법
## web.xml 기반 설정
`web.xml`은 전통적인 설정 방식으로, 웹 구성 요소를 XML 파일에 명시적으로 등록한다.<br>
서블릿 컨테이너는 `web.xml`에 기술된 내용을 기반으로 초기화를 진행한다.

### 예시
```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee 
                             http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         version="3.1">

    <listener>
        <listener-class>com.example.ExampleListener</listener-class>
    </listener>

    <servlet>
        <servlet-name>exampleServlet</servlet-name>
        <servlet-class>com.example.ExampleServlet</servlet-class>
        <load-on-startup>1</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>exampleServlet</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>

    <filter>
        <filter-name>exampleFilter</filter-name>
        <filter-class>com.example.ExampleFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>exampleFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

</web-app>
```

## 어노테이션 기반 설정
`@WebListener`, `@WebServlet`, `@WebFilter`은 Servlet 3.0 스펙에 추가된 어노테이션으로, `web.xml`에 명시하지 않고도 웹 구성 요소를 등록할 수 있다.

### 예시
```java
@WebListener
public class ExampleListener implements ServletContextListener {

    @Override
    public void contextInitialized(ServletContextEvent servletContextEvent) {
        System.out.println("ExampleListener contextInitialized");
    }

    @Override
    public void contextDestroyed(ServletContextEvent servletContextEvent) {
        System.out.println("ExampleListener contextDestroyed");
    }
}
```

```java
@WebServlet(value = "/", loadOnStartup = 1)
public class ExampleServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String protocol = req.getProtocol();
        resp.getWriter().write("ExampleServlet : [" + protocol + "]\n");
        resp.getWriter().write("RequestURI : [" + req.getRequestURI() + "]");
    }
}
```

```java
@WebFilter("/*")
public class ExampleServlet extends HttpServlet {

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        System.out.println("ExampleFilter init");
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) servletRequest;
        System.out.println("ExampleFilter doFilter [" + request.getRequestURI() + "]");
        filterChain.doFilter(servletRequest, servletResponse);
    }

    @Override
    public void destroy() {
        System.out.println("ExampleFilter destroy");
    }
}
```

## ServletContainerInitializer 기반 설정
`ServletContainerInitializer`는 Servlet 3.0 스펙에 추가된 표준 인터페이스로, 서블릿 컨테이너의 초기화를 담당한다.
이를 통해 기존 `web.xml`을 대체할 수 있다.

### ServletContainerInitializer
```java
public interface ServletContainerInitializer {
    void onStartup(Set<Class<?>> c, ServletContext ctx) throws ServletException;
}
```
- `c`: `@HandlesTypes`로 지정된 클래스들의 집합
- `ctx`: 컨테이너 환경에 접근할 수 있는 객체(서블릿, 필터, 리스너 등록 가능)

### @HandlesTypes
`@HandlesTypes`는 `ServletContainerInitializer`가 어떤 타입을 다룰 것인지를 지정하기 위한 어노테이션이다.

구현 클래스에 `@HandlesTypes`를 사용하면 `@HandlesTypes` 안에 지정한 타입을 상속(또는 구현)한 클래스를 찾아서 `onStartup` 메서드의 파라미터로 넣어준다. 

### 구현 클래스 등록
`META-INF/services/javax.servlet.ServletContainerInitializer` 파일에 `ServletContainerInitializer` 구현 클래스를 지정해야 한다.<br>
(servlet-api 버전에 따라 `javax` 또는 `jakarta`)

이 파일은 서블릿 컨테이너(Tomcat, Jetty 등)가 애플리케이션 시작 시 `ServletContainerInitializer` 인터페이스 구현을 찾고 로드하는 데 사용된다.

> **SPI(Service Provider Interface, 서비스 제공자 인터페이스)**
>
> SPI는 제3자가 특정 기능을 구현하거나 확장할 수 있도록 의도된 표준 인터페이스이다.<br>
> `ServiceLoader` 클래스는 서비스 구현을 로드하는 기능을 하며, `META-INF/services` 폴더의 파일을 기반으로 서비스 구현체를 로드한다.
> 
> `ServletContainerInitializer`는 SPI 개념을 기반으로 하여 서블릿 컨테이너 초기화를 확장할 수 있도록 한다.

### 예시
```java
@HandlesTypes({ExampleWebInitializer.class})
public class ExampleServletContainerInitializer implements ServletContainerInitializer {

    @Override
    public void onStartup(Set<Class<?>> set, ServletContext servletContext) throws ServletException {
        System.out.println("ExampleServletContainerInitializer onStartup");

        for(Class<?> handleClass: set) {
            System.out.println(handleClass.getName());
        }

        servletContext.addListener(ExampleListener.class);

        ServletRegistration.Dynamic servlet = servletContext.addServlet("exampleServlet", ExampleServlet.class);
        servlet.setLoadOnStartup(1);
        servlet.addMapping("/");

        FilterRegistration.Dynamic filter = servletContext.addFilter("exampleFilter", ExampleFilter.class);
        filter.addMappingForUrlPatterns(null, true, "/*");
    }
}
```

`META-INF/services` 폴더에 `javax.servlet.ServletContainerInitializer` 파일을 생성한다.<br>
파일 내용으로 `ServletContainerInitializer`를 구현한 클래스의 경로를 입력한다.
```
com.example.ExampleServletContainerInitializer
```

---
**Reference**<br>
- https://blog.naver.com/tmondev/220624553053
- https://nuheajiohc.tistory.com/20
- https://www.baeldung.com/java-spi
